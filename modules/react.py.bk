"""
PÃ¡gina React - GeraÃ§Ã£o de roteiros estilo React baseados em vÃ­deos
"""
import streamlit as st
from datetime import datetime
from services.video_processing import (
    extract_transcription_from_url, validate_video_url, 
    extract_video_info, select_best_segment
)
from services.ai_agents import generate_react_script
from utils.helpers import salvar_roteiro
from components.layout import (
    render_status_card, render_roteiro_display, render_statistics_section
)

def render_react_page():
    """Renderiza a pÃ¡gina principal de React"""
    st.header("ğŸ­ React")
    
    
    # InformaÃ§Ãµes sobre a funcionalidade
    with st.expander("â„¹ï¸ Como funciona", expanded=False):
        st.markdown("""
        **Fluxo da pÃ¡gina React:**
        
        1. **Cole o link do vÃ­deo** que vocÃª quer usar como base
        2. **Descreva o vÃ­deo** e o tipo de abordagem desejada
        3. **Escolha o estilo de React:**
           - **React PadrÃ£o**: Mostra o trecho + headline + conteÃºdo + posicionamento
           - **React Bate-Bola**: Headline + bate-bola (trecho + reaÃ§Ã£o) + posicionamento
        4. **Gere o roteiro** personalizado
        
        **Plataformas suportadas:** YouTube, TikTok, Instagram
        """)
    
    # FormulÃ¡rio principal
    with st.form("form_react"):
        st.markdown("### ğŸ“² ConfiguraÃ§Ã£o do React")
        
        # Input do link do vÃ­deo
        video_url = st.text_input(
            "ğŸ”— Link do vÃ­deo:",
            placeholder="https://www.youtube.com/watch?v=...",
            help="Cole aqui o link do vÃ­deo que vocÃª quer usar como base para o React"
        )
        
        # DescriÃ§Ã£o e abordagem
        descricao_video = st.text_area(
            "ğŸ“ Descreva o vÃ­deo e o tipo de abordagem desejada:",
            placeholder="Ex: VÃ­deo sobre investimentos para iniciantes. Quero focar na parte onde ele fala sobre diversificaÃ§Ã£o...",
            height=100,
            help="Descreva o conteÃºdo do vÃ­deo e que tipo de abordagem vocÃª quer dar no seu React"
        )
        
        # SeleÃ§Ã£o do estilo de React
        col1, col2 = st.columns(2)
        
        with col1:
            estilo_react = st.radio(
                "ğŸ¬ Estilo de React:",
                ["React PadrÃ£o", "React Bate-Bola"],
                help="Escolha o formato do seu vÃ­deo React"
            )
        
        with col2:
            # ExplicaÃ§Ã£o dos estilos
            if estilo_react == "React PadrÃ£o":
                st.info("""
                **React PadrÃ£o:**
                1. Trecho do vÃ­deo (30-50s)
                2. Headline (3-10s)
                3. ConteÃºdo principal (15-30s)
                4. Posicionamento + CTA
                """)
            else:
                st.info("""
                **React Bate-Bola:**
                1. Headline (3-5s)
                2. Bate-bola: Trecho + ReaÃ§Ã£o
                3. Posicionamento + CTA
                """)
        
        # BotÃ£o de geraÃ§Ã£o
        gerar_roteiro = st.form_submit_button("ğŸš€ Gerar Roteiro React", type="primary")
    
    # Processamento quando o formulÃ¡rio Ã© submetido
    if gerar_roteiro:
        if not video_url.strip():
            st.error("âŒ Por favor, adicione o link do vÃ­deo.")
            return
        
        if not descricao_video.strip():
            st.error("âŒ Por favor, descreva o vÃ­deo e a abordagem desejada.")
            return
        
        # Valida a URL
        url_valida, mensagem_validacao = validate_video_url(video_url)
        
        if not url_valida:
            st.error(f"âŒ {mensagem_validacao}")
            return
        
        # Processa o vÃ­deo
        processar_video_react(video_url, descricao_video, estilo_react)
    
    # Exibe resultado se houver
    if "roteiro_react_atual" in st.session_state:
        exibir_resultado_react()


def processar_video_react(video_url, descricao_video, estilo_react):
    """Processa o vÃ­deo e gera o roteiro React"""
    
    try:
        # Extrai informaÃ§Ãµes do vÃ­deo
        with st.spinner("ğŸ“¹ Analisando vÃ­deo..."):
            video_info = extract_video_info(video_url)
            
            # Mostra informaÃ§Ãµes do vÃ­deo
            col1, col2, col3, col4 = st.columns(4)
            with col1:
                st.metric("Plataforma", video_info["platform"])
            with col2:
                st.metric("DuraÃ§Ã£o", video_info["duration"])
            with col3:
                st.write(f"**TÃ­tulo:** {video_info['title']}")
            with col4:
                st.write(f"**Autor:** {video_info['author']}")
        
        # Extrai transcriÃ§Ã£o
        with st.spinner("ğŸ¤ Extraindo transcriÃ§Ã£o..."):
            transcricao = extract_transcription_from_url(video_url)
            
            if not transcricao:
                st.error("âŒ NÃ£o foi possÃ­vel extrair a transcriÃ§Ã£o do vÃ­deo.")
                return
            
            # Mostra prÃ©via da transcriÃ§Ã£o
            with st.expander("ğŸ“„ TranscriÃ§Ã£o extraÃ­da", expanded=False):
                st.text_area("ConteÃºdo:", value=transcricao, height=200, disabled=True)
        
        # Seleciona melhor segmento automaticamente
        with st.spinner("âœ‚ï¸ Selecionando melhor segmento..."):
            segmento_selecionado = select_best_segment(transcricao, target_duration=45)
            
            st.success(f"âœ… Segmento selecionado ({len(segmento_selecionado.split())} palavras)")
            
            with st.expander("ğŸ“ Segmento selecionado", expanded=True):
                st.text_area("Trecho para o React:", value=segmento_selecionado, height=150, disabled=True)
        
        # Gera roteiro com IA
        with st.spinner("ğŸ¤– Gerando roteiro React..."):
            roteiro_react = generate_react_script(
                transcription=segmento_selecionado,
                instrucoes=descricao_video,
                estilo_react=estilo_react
            )
            
            if roteiro_react:
                # Salva no estado da sessÃ£o
                st.session_state["roteiro_react_atual"] = {
                    "conteudo": roteiro_react,
                    "video_url": video_url,
                    "video_info": video_info,
                    "transcricao": transcricao,
                    "segmento": segmento_selecionado,
                    "descricao": descricao_video,
                    "estilo": estilo_react,
                    "data": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                }
                
                st.success("âœ… Roteiro React gerado com sucesso!")
            else:
                st.error("âŒ Erro ao gerar roteiro. Tente novamente.")
                
    except Exception as e:
        st.error(f"âŒ Erro no processamento: {str(e)}")


def exibir_resultado_react():
    """Exibe o resultado do roteiro React gerado"""
    
    st.markdown("---")
    st.subheader("ğŸ¬ Roteiro React Gerado")
    
    roteiro_data = st.session_state["roteiro_react_atual"]
    
    # InformaÃ§Ãµes do vÃ­deo original
    with st.expander("ğŸ“¹ InformaÃ§Ãµes do vÃ­deo original", expanded=False):
        col1, col2 = st.columns(2)
        
        with col1:
            st.write(f"**ğŸ”— URL:** {roteiro_data['video_url']}")
            st.write(f"**ğŸ“± Plataforma:** {roteiro_data['video_info']['platform']}")
            st.write(f"**â±ï¸ DuraÃ§Ã£o:** {roteiro_data['video_info']['duration']}")
        
        with col2:
            st.write(f"**ğŸ“ TÃ­tulo:** {roteiro_data['video_info']['title']}")
            st.write(f"**ğŸ‘¤ Autor:** {roteiro_data['video_info']['author']}")
            st.write(f"**ğŸ­ Estilo:** {roteiro_data['estilo']}")
        
        st.write(f"**ğŸ’­ DescriÃ§Ã£o/InstruÃ§Ãµes:** {roteiro_data['descricao']}")
    
    # TÃ­tulo editÃ¡vel
    titulo_roteiro = st.text_input(
        "ğŸ“ TÃ­tulo do roteiro:",
        value=f"React - {roteiro_data['video_info']['title'][:50]}...",
        key="titulo_react_edicao"
    )
    
    # ConteÃºdo editÃ¡vel
    conteudo_editado = st.text_area(
        "ğŸ¬ Roteiro React:",
        value=roteiro_data["conteudo"],
        height=400,
        key="conteudo_react_edicao",
        help="VocÃª pode editar o roteiro gerado conforme necessÃ¡rio"
    )
    
    # EstatÃ­sticas do roteiro
    render_statistics_section(conteudo_editado)
    
    # Segmento usado
    with st.expander("ğŸ“„ Segmento do vÃ­deo usado", expanded=False):
        st.text_area(
            "Trecho utilizado:",
            value=roteiro_data["segmento"],
            height=150,
            disabled=True
        )
    
    # BotÃµes de aÃ§Ã£o
    st.markdown("---")
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        if st.button("ğŸ’¾ Salvar no HistÃ³rico", type="primary", key="salvar_react"):
            roteiro_data_completo = {
                "titulo": titulo_roteiro,
                "conteudo": conteudo_editado,
                "formato": f"React {roteiro_data['estilo']}",
                "instrucao": f"React {roteiro_data['estilo']} - {roteiro_data['descricao']}",
                "data": datetime.now().isoformat(),
                "timestamp": datetime.now().isoformat()
            }
            salvar_roteiro(roteiro_data_completo)
            st.success("âœ… Roteiro React salvo no histÃ³rico!")
    
    with col2:
        st.download_button(
            "â¬‡ï¸ Baixar Roteiro",
            data=conteudo_editado,
            file_name=f"{titulo_roteiro}.txt",
            mime="text/plain",
            key="download_react"
        )
    
    with col3:
        if st.button("ğŸ“‹ Copiar", key="copiar_react"):
            st.code(conteudo_editado, language="text")
            st.info("ğŸ“‹ Roteiro exibido acima para cÃ³pia manual.")
    
    with col4:
        if st.button("ğŸ”„ Novo React", key="novo_react"):
            if "roteiro_react_atual" in st.session_state:
                del st.session_state["roteiro_react_atual"]
            st.rerun()
    
    # Dicas para melhorar o React
    st.markdown("---")
    with st.expander("ğŸ’¡ Dicas para um React de sucesso", expanded=False):
        st.markdown("""
        **ğŸ¯ Para React PadrÃ£o:**
        - Certifique-se de que o trecho escolhido seja impactante
        - A headline deve criar curiosidade imediata
        - O conteÃºdo principal deve agregar valor real
        - O posicionamento deve ser claro e memorÃ¡vel
        
        **âš¡ Para React Bate-Bola:**
        - A reaÃ§Ã£o deve ser autÃªntica e espontÃ¢nea
        - Use expressÃµes faciais e gestos marcantes
        - O timing entre trecho e reaÃ§Ã£o Ã© crucial
        - Mantenha a energia alta durante todo o vÃ­deo
        
        **ğŸ“± Dicas gerais:**
        - Teste diferentes Ã¢ngulos de cÃ¢mera
        - Use boa iluminaÃ§Ã£o e Ã¡udio claro
        - Mantenha o ritmo dinÃ¢mico
        - Inclua legendas para maior alcance
        """)


def render_tutorial_react():
    """Renderiza tutorial sobre como fazer vÃ­deos React"""
    
    st.markdown("### ğŸ“š Tutorial: Como fazer um vÃ­deo React")
    
    with st.expander("ğŸ¬ Passo a passo para gravar", expanded=False):
        st.markdown("""
        **1. PreparaÃ§Ã£o:**
        - Escolha um vÃ­deo relevante para seu nicho
        - Defina qual trecho vocÃª vai usar (30-50 segundos)
        - Prepare seu posicionamento e CTA
        
        **2. ConfiguraÃ§Ã£o tÃ©cnica:**
        - Use boa iluminaÃ§Ã£o (luz natural ou ring light)
        - Posicione a cÃ¢mera na altura dos olhos
        - Teste o Ã¡udio antes de gravar
        
        **3. GravaÃ§Ã£o:**
        - Grave primeiro sua introduÃ§Ã£o (headline)
        - Reproduza o trecho do vÃ­deo original
        - Grave sua reaÃ§Ã£o/comentÃ¡rio imediatamente apÃ³s
        - Finalize com seu posicionamento e CTA
        
        **4. EdiÃ§Ã£o:**
        - Mantenha cortes dinÃ¢micos
        - Adicione legendas
        - Use transiÃ§Ãµes suaves
        - Mantenha duraÃ§Ã£o entre 60-90 segundos
        """)
    
    with st.expander("ğŸ¯ Melhores prÃ¡ticas", expanded=False):
        st.markdown("""
        **âœ… FaÃ§a:**
        - ReaÃ§Ãµes autÃªnticas e espontÃ¢neas
        - ComentÃ¡rios que agregam valor
        - Posicionamento claro da sua expertise
        - CTAs especÃ­ficos e acionÃ¡veis
        
        **âŒ Evite:**
        - ReaÃ§Ãµes exageradas ou falsas
        - ComentÃ¡rios Ã³bvios ou vazios
        - VÃ­deos muito longos (+ 90s)
        - Usar conteÃºdo protegido por direitos autorais
        
        **ğŸ”¥ Para viralizar:**
        - Escolha vÃ­deos que jÃ¡ estÃ£o em alta
        - Adicione uma perspectiva Ãºnica
        - Use hashtags relevantes
        - Poste no horÃ¡rio de maior engajamento
        """)


# FunÃ§Ã£o auxiliar para validaÃ§Ã£o de entrada
def validar_entrada_react(video_url, descricao_video):
    """Valida as entradas do formulÃ¡rio React"""
    
    erros = []
    
    if not video_url.strip():
        erros.append("Link do vÃ­deo Ã© obrigatÃ³rio")
    
    if not descricao_video.strip():
        erros.append("DescriÃ§Ã£o do vÃ­deo Ã© obrigatÃ³ria")
    
    if video_url.strip():
        url_valida, mensagem = validate_video_url(video_url)
        if not url_valida:
            erros.append(mensagem)
    
    return erros

